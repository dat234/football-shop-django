{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thanh to√°n ƒë∆°n h√†ng #{{ order.order_code }}</title>
    <link rel="icon" type="image/png" href="{% static 'image/favicon-96x96.png' %}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{% static 'image/favicon.svg' %}" />
    <link rel="shortcut icon" href="{% static 'image/favicon.ico' %}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'image/apple-touch-icon.png' %}" />
    <meta name="apple-mobile-web-app-title" content="BODAH" />
    <link rel="manifest" href="{% static 'image/site.webmanifest' %}" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/store/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/store/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/store/payment_info.css' %}">
    <link rel="stylesheet" href="{% static 'css/store/dark-theme.css' %}">
</head>
<body>
    {% include "layout/header.html" %}
    {% include "layout/message.html" %}

    <div class="payment-page-container">
        <div class="payment-left-section">
            
            <div class="payment-header-row">
                <a href="{% url 'checkout' %}" class="back-link">&lt; Quay l·∫°i</a>
                <h3>Chuy·ªÉn kho·∫£n qua QR</h3>
            </div>

            <div class="instruction-box">
                <h4>H∆∞·ªõng d·∫´n</h4>
                <ul class="step-list">
                    <li><span class="step-num">1</span> M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng / v√≠ ƒëi·ªán t·ª≠</li>
                    <li><span class="step-num">2</span> Qu√©t m√£ QR ho·∫∑c nh·∫≠p th√¥ng tin b√™n d∆∞·ªõi ƒë·ªÉ chuy·ªÉn kho·∫£n</li>
                    <li><span class="step-num">3</span> Sau khi chuy·ªÉn kho·∫£n th√†nh c√¥ng, vui l√≤ng t·∫£i ·∫£nh minh ch·ª©ng v√† b·∫•m x√°c nh·∫≠n b√™n d∆∞·ªõi.</li>
                </ul>
            </div>

            <div class="bank-info-container">
                <div class="bank-details">
                    <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                    <div class="detail-row">
                        <span class="label">T√†i kho·∫£n</span>
                        <span class="value">VU QUOC BAO</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Ng√¢n h√†ng</span>
                        <span class="value">MB BANK</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">S·ªë t√†i kho·∫£n</span>
                        <span class="value">0918125904 <i class="copy-icon" onclick="copyText('0918125904')">
                            <img src="{% static 'image/copy_icon.svg' %}" alt="Copy" class="copy-icon-img">
                        </i></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">N·ªôi dung</span>
                        <span class="value highlight-blue">{{ order.order_code }} <i class="copy-icon" onclick="copyText('{{ order.order_code }}')">
                            <img src="{% static 'image/copy_icon.svg' %}" alt="Copy" class="copy-icon-img">
                        </i></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">S·ªë ti·ªÅn</span>
                        <span class="value highlight-price">{{ order.total_price|vnd }}ƒë <i class="copy-icon" onclick="copyText('{{ order.total_price|floatformat:0 }}')">
                            <img src="{% static 'image/copy_icon.svg' %}" alt="Copy" class="copy-icon-img">
                        </i></span>
                    </div>
                    
                    <div class="note-box">
                        L∆∞u √Ω: Vui l√≤ng ki·ªÉm tra ƒë√∫ng N·ªôi dung chuy·ªÉn kho·∫£n ƒë·ªÉ c·ª≠a h√†ng c√≥ th·ªÉ x√°c minh ch√≠nh x√°c giao d·ªãch c·ªßa b·∫°n.
                    </div>
                </div>

                <div class="qr-code-box">
                    <p class="qr-title">Qu√©t m√£ QR ƒë·ªÉ chuy·ªÉn kho·∫£n</p>                    
                    <div class="qr-img-wrapper">
                        <img src="{% static 'image/mb_qr.png' %}" alt="QR Code">
                    </div>
                </div>
            </div>

            <form method="POST" enctype="multipart/form-data" class="upload-proof-section" onsubmit="return validateForm()">
                {% csrf_token %}
                <h4>H√¨nh ·∫£nh chuy·ªÉn kho·∫£n</h4>
                <p class="upload-desc">T·∫£i l√™n ·∫£nh ch·ª•p m√†n h√¨nh chuy·ªÉn kho·∫£n ƒë·ªÉ c·ª≠a h√†ng d·ªÖ d√†ng x√°c minh giao d·ªãch b·∫°n nh√©.</p>
                
                <div class="upload-area">
                    <input type="file" name="payment_proof" id="proof_file" accept="image/*" required onchange="previewImage(this)">
                    <label for="proof_file" class="upload-btn">
                        T·∫£i l√™n
                    </label>
                    <div id="file-name-display">Ch∆∞a ch·ªçn ·∫£nh n√†o</div>
                </div>

                <img id="image-preview" src="#" alt="Xem tr∆∞·ªõc ·∫£nh" style="display: none; max-width: 200px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd;">

                <button type="submit" class="btn-confirm-payment">X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N</button>
            </form>

        </div>

        <div class="payment-right-section">
            <div class="cart-summary-card">
                <h3>Gi·ªè h√†ng</h3>
                <div class="item-list">
                    {% for item in order.items %}
                    <div class="summary-item">
                        <div class="item-img">
                            {% if item.product.image %}
                            <img src="{{ item.product.image }}" alt="{{ item.product.name }}">
                            {% else %}
                            <div class="no-img">üì∑</div>
                            {% endif %}
                        </div>
                        <div class="item-info">
                            <p class="name">{{ item.product.name }}</p>
                            <p class="variant">x{{ item.quantity }}</p>
                            <p class="price">{{ item.product.price }} VNƒê</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <hr>
                <div class="total-row">
                    <span>T·ªïng ti·ªÅn h√†ng</span>
                    <span>{{ order.total_price|vnd }}ƒë</span>
                </div>
                <div class="total-row final">
                    <span>T·ªïng thanh to√°n</span>
                    <span>{{ order.total_price|vnd }}ƒë</span>
                </div>
            </div>
        </div>
    </div>

    {% include "layout/footer.html" %}

    <script src="{% static 'js/theme-toggle.js' %}"></script>
    <script src="{% static 'js/toast.js' %}"></script>
    <script>
        // T·ª± ƒë·ªông hi·ªÉn th·ªã th√¥ng b√°o t·ª´ Server (Django messages) b·∫±ng Toast
        document.addEventListener('DOMContentLoaded', function() {
            {% if messages %}
                {% for message in messages %}
                    if (typeof toast === 'function') {
                        toast({
                            title: "{% if 'success' in message.tags %}Th√†nh c√¥ng{% elif 'error' in message.tags %}Th·∫•t b·∫°i{% else %}Th√¥ng b√°o{% endif %}",
                            message: "{{ message|escapejs }}",
                            type: "{% if 'success' in message.tags %}success{% elif 'error' in message.tags %}error{% else %}info{% endif %}"
                        });
                    }
                {% endfor %}
            {% endif %}
        });

        // Script xem tr∆∞·ªõc ·∫£nh
        function previewImage(input) {
            var preview = document.getElementById('image-preview');
            var fileName = document.getElementById('file-name-display');
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
                fileName.textContent = "ƒê√£ ch·ªçn: " + input.files[0].name;
                fileName.style.color = "#10B981";
            }
        }
        
        // Script copy
        function copyText(text) {
            navigator.clipboard.writeText(text);
            if (typeof toast === 'function') {
                toast({
                    title: "Th√†nh c√¥ng",
                    message: "ƒê√£ sao ch√©p: " + text,
                    type: "success"
                });
            } else {
                alert("ƒê√£ sao ch√©p: " + text);
            }
        }

        function validateForm() {
            var fileInput = document.getElementById('proof_file');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("Vui l√≤ng t·∫£i l√™n ·∫£nh minh ch·ª©ng chuy·ªÉn kho·∫£n tr∆∞·ªõc khi x√°c nh·∫≠n!");
                return false;
            }
            return true;
        }
    </script>
</body>
</html>