{% load static %}

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }}</title>
    <link rel="icon" type="image/png" href="{% static 'image/favicon-96x96.png' %}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{% static 'image/favicon.svg' %}" />
    <link rel="shortcut icon" href="{% static 'image/favicon.ico' %}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'image/apple-touch-icon.png' %}" />
    <meta name="apple-mobile-web-app-title" content="MyWebSite" />
    <link rel="manifest" href="{% static 'image/site.webmanifest' %}" />

    <link rel="stylesheet" href="{% static 'css/store/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/store/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/store/product_detail.css' %}">
    <link rel="stylesheet" href="{% static 'css/store/message.css' %}">
</head>

<body>
    {% include "layout/header.html" %}
    {% include "layout/message.html" %}

    <main class="product-page">
        <div class="product-container">
            <div class="product-breadcrumbs">
                <a href="{% url 'home' %}"> &lt; Quay lại trang chủ</a>
                <a href="{% url 'cart_view' %}">Xem Giỏ Hàng</a>
            </div>

            <div class="product-main-layout">
                
                <div class="product-image-gallery">
                    <img src="{{ product.image }}" alt="{{ product.name }}">
                </div>

                <div class="product-info">
                    <h1>{{ product.name }}</h1>
                    <p class="product-price">{{ product.price|floatformat:0 }} VNĐ</p>
                    <p class="product-stock">Số lượng còn lại: {{ product.stock }}</p>

                    <div class="product-description">
                        <h3>Mô tả chi tiết:</h3>
                        <p>{{ product.description|linebreaks }}</p>
                    </div>

                    {% if product.stock > 0 %}
                        {% if user.is_authenticated %}
                            <form action="{% url 'add_to_cart' product.id %}" method="POST" class="add-to-cart-form">
                                {% csrf_token %}
                                <div class="quantity-group">
                                    <label for="quantity">Số lượng:</label>
                                    <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}">
                                </div>
                                
                                <button type="submit" name="action" value="add_to_cart" class="btn-primary">
                                    Thêm vào giỏ hàng
                                </button>
                            </form>
                        {% else %}
                            <div class="add-to-cart-form">
                                <div class="quantity-group">
                                    <label for="quantity">Số lượng:</label>
                                    <input type="number" value="1" disabled style="background-color: #eee; cursor: not-allowed;">
                                </div>

                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn-primary" style="display: flex; align-items: center; justify-content: center; height: 50px;">
                                    Thêm vào giỏ hàng
                                </a>
                            </div>
                        {% endif %}

                    {% else %}
                        <p class="out-of-stock-msg">Sản phẩm này đã hết hàng.</p>
                    {% endif %}
                </div>
            </div>


            <div class="product-reviews">
                <h2>Đánh giá từ khách hàng ({{ reviews.count }})</h2>
                
                {% if average_rating %}
                <p class="average-rating">
                    <strong>Điểm trung bình: {{ average_rating|floatformat:1 }}/5.0</strong>
                </p>
                {% endif %}

                <div class="review-list">
                    {% if reviews %}
                        {% for review in reviews %}
                        <div class="review-item">
                            <div class="review-header">
                                <span class="review-user">{{ review.user.username }}</span>
                                <span class="review-rating">{{ review.rating }} sao</span>
                                <small class="review-date">{{ review.created_at|date:"d/m/Y H:i" }}</Gia small>
                            </div>
                            {% if review.comment %}
                            <p class="review-comment">{{ review.comment|linebreaks }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p>Chưa có đánh giá nào cho sản phẩm này.</p>
                    {% endif %}
                </div>

                {% if user.is_authenticated %}
                    {% if can_review %}
                    <form action="{% url 'product_detail' product.id %}" method="POST" class="review-form">
                        <h3>Viết đánh giá của bạn</h3>
                        {% csrf_token %}
                        <div class="review-form-group">
                            <label for="rating">Xếp hạng:</label>
                            <select name="rating" required>
                                <option value="">-- Chọn sao --</option>
                                <option value="5">5 sao (Rất tốt)</option>
                                <option value="4">4 sao (Tốt)</option>
                                <option value="3">3 sao (Bình thường)</option>
                                <option value="2">2 sao (Tệ)</option>
                                <option value="1">1 sao (Rất tệ)</option>
                            </select>
                        </div>
                        <div class="review-form-group">
                            <label for="comment">Bình luận (tùy chọn):</label>
                            <textarea name="comment" rows="4"></textarea>
                        </div>
                        
                        <button type="submit" name="action" value="submit_review" class="btn-primary">
                            Gửi đánh giá
                        </button>
                    </form>
                    {% else %}
                    <p class="review-form"><i>{{ review_message }}</i></p> 
                    {% endif %}
                {% else %}
                <p class="review-form">
                    <a href="{% url 'login' %}?next={{ request.path }}">Đăng nhập</a> để viết đánh giá.
                </p>
                {% endif %}
            </div>
        </div>
    </main>

    {% include "layout/footer.html" %}

    <script src="{% static 'js/toast.js' %}"></script>
    <script src="{% static 'js/ajax-handler.js' %}"></script>
</body>
</html>